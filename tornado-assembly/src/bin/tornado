#!/usr/bin/env bash

#
# Copyright (c) 2013-2025, APT Group, Department of Computer Science,
# The University of Manchester.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

# ########################################################
# TornadoVM Dependency Checker and Launcher Wrapper
# ########################################################

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Detect OS
detect_os() {
    if [[ "$OSTYPE" == "linux-gnu"* ]]; then
        OS="linux"
        # Detect Linux distribution
        if [ -f /etc/os-release ]; then
            . /etc/os-release
            DISTRO=$ID
        elif [ -f /etc/lsb-release ]; then
            . /etc/lsb-release
            DISTRO=$DISTRIB_ID
        else
            DISTRO="unknown"
        fi
    elif [[ "$OSTYPE" == "darwin"* ]]; then
        OS="macos"
        DISTRO="macos"
    else
        OS="unknown"
        DISTRO="unknown"
    fi
}

# Print colored message
print_error() {
    echo -e "${RED}[ERROR]${NC} $1" >&2
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1" >&2
}

print_info() {
    echo -e "${BLUE}[INFO]${NC} $1" >&2
}

print_success() {
    echo -e "${GREEN}[OK]${NC} $1" >&2
}

# Check if command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Check Python3
check_python3() {
    if command_exists python3; then
        return 0
    else
        print_error "Python3 is not installed"
        echo "" >&2
        echo "TornadoVM requires Python3 to run." >&2
        echo "" >&2
        echo "To install Python3:" >&2
        echo "" >&2

        case $DISTRO in
            ubuntu|debian)
                echo -e "  ${GREEN}sudo apt update${NC}" >&2
                echo -e "  ${GREEN}sudo apt install -y python3${NC}" >&2
                ;;
            fedora|rhel|centos|rocky|almalinux)
                echo -e "  ${GREEN}sudo dnf install -y python3${NC}" >&2
                ;;
            arch|manjaro)
                echo -e "  ${GREEN}sudo pacman -S python${NC}" >&2
                ;;
            opensuse*)
                echo -e "  ${GREEN}sudo zypper install python3${NC}" >&2
                ;;
            macos)
                if command_exists brew; then
                    echo -e "  ${GREEN}brew install python3${NC}" >&2
                else
                    echo "  Install Homebrew first: https://brew.sh" >&2
                    echo -e "  Then run: ${GREEN}brew install python3${NC}" >&2
                fi
                ;;
            *)
                echo "  Please install Python3 using your system's package manager" >&2
                ;;
        esac
        echo "" >&2
        return 1
    fi
}

# Check JAVA_HOME
check_java() {
    if [ -z "$JAVA_HOME" ]; then
        print_error "JAVA_HOME environment variable is not set"
        echo "" >&2
        echo "TornadoVM requires JAVA_HOME to be set to a JDK 21 installation." >&2
        echo "" >&2
        echo "To set JAVA_HOME, add this to your ~/.bashrc or ~/.zshrc:" >&2
        echo "" >&2
        echo -e "  ${GREEN}export JAVA_HOME=/path/to/jdk-21${NC}" >&2
        echo -e "  ${GREEN}export PATH=\$JAVA_HOME/bin:\$PATH${NC}" >&2
        echo "" >&2
        echo "To install JDK 21:" >&2
        echo "" >&2

        case $DISTRO in
            ubuntu|debian)
                echo -e "  ${GREEN}sudo apt update${NC}" >&2
                echo -e "  ${GREEN}sudo apt install -y openjdk-21-jdk${NC}" >&2
                echo "" >&2
                echo "Or use SDKMAN (recommended):" >&2
                echo -e "  ${GREEN}curl -s \"https://get.sdkman.io\" | bash${NC}" >&2
                echo -e "  ${GREEN}sdk install java 21.0.1-graal${NC}" >&2
                ;;
            fedora|rhel|centos|rocky|almalinux)
                echo -e "  ${GREEN}sudo dnf install -y java-21-openjdk-devel${NC}" >&2
                ;;
            arch|manjaro)
                echo -e "  ${GREEN}sudo pacman -S jdk21-openjdk${NC}" >&2
                ;;
            macos)
                echo -e "  ${GREEN}brew install openjdk@21${NC}" >&2
                echo "" >&2
                echo "Or use SDKMAN (recommended):" >&2
                echo -e "  ${GREEN}curl -s \"https://get.sdkman.io\" | bash${NC}" >&2
                echo -e "  ${GREEN}sdk install java 21.0.1-graal${NC}" >&2
                ;;
            *)
                echo "  Visit: https://adoptium.net/ or https://www.graalvm.org/" >&2
                ;;
        esac
        echo "" >&2
        return 1
    fi

    if [ ! -d "$JAVA_HOME" ]; then
        print_error "JAVA_HOME is set but directory does not exist: $JAVA_HOME"
        return 1
    fi

    if [ ! -x "$JAVA_HOME/bin/java" ]; then
        print_error "Java executable not found in JAVA_HOME: $JAVA_HOME/bin/java"
        return 1
    fi

    return 0
}

# Check TORNADOVM_HOME
check_tornado_sdk() {
    # Use TORNADOVM_HOME (SDKMAN compliant)
    # Fall back to deprecated TORNADO_SDK for backward compatibility
    if [ -z "$TORNADOVM_HOME" ]; then
        if [ -n "$TORNADO_SDK" ]; then
            print_warning "TORNADO_SDK is deprecated, please use TORNADOVM_HOME instead"
            export TORNADOVM_HOME="$TORNADO_SDK"
        else
            print_error "TORNADOVM_HOME environment variable is not set"
            echo "" >&2
            echo "Please set TORNADOVM_HOME to point to your TornadoVM installation." >&2
            echo "" >&2
            echo "Add this to your ~/.bashrc or ~/.zshrc:" >&2
            echo "" >&2
            echo -e "  ${GREEN}export TORNADOVM_HOME=/path/to/tornadovm/sdk${NC}" >&2
            echo -e "  ${GREEN}export PATH=\$TORNADOVM_HOME/bin:\$PATH${NC}" >&2
            echo "" >&2
            return 1
        fi
    fi

    if [ ! -d "$TORNADOVM_HOME" ]; then
        print_error "TORNADOVM_HOME is set but directory does not exist: $TORNADOVM_HOME"
        return 1
    fi

    return 0
}

# Get installed backends from tornado.backend file
get_installed_backends() {
    local backend_file="$TORNADOVM_HOME/etc/tornado.backend"
    if [ -f "$backend_file" ]; then
        INSTALLED_BACKENDS=$(grep "tornado.backends" "$backend_file" | cut -d'=' -f2 | tr ',' ' ')
    else
        INSTALLED_BACKENDS=""
    fi
}

# Check OpenCL dependencies
check_opencl_backend() {
    local opencl_ok=true

    # Check for OpenCL ICD loader
    if [ "$OS" == "linux" ]; then
        if ! ldconfig -p 2>/dev/null | grep -q libOpenCL.so; then
            print_warning "OpenCL ICD loader is not installed"
            echo "" >&2
            echo "The OpenCL backend requires OpenCL ICD loader." >&2
            echo "" >&2
            echo "To install OpenCL dependencies:" >&2
            echo "" >&2

            case $DISTRO in
                ubuntu|debian)
                    echo -e "  ${GREEN}sudo apt update${NC}" >&2
                    echo -e "  ${GREEN}sudo apt install -y ocl-icd-opencl-dev opencl-headers${NC}" >&2
                    echo "" >&2
                    echo "For Intel GPUs, also install:" >&2
                    echo -e "  ${GREEN}sudo apt install -y intel-opencl-icd${NC}" >&2
                    echo "" >&2
                    echo "For AMD GPUs, also install:" >&2
                    echo -e "  ${GREEN}sudo apt install -y mesa-opencl-icd${NC}" >&2
                    echo "" >&2
                    echo "For NVIDIA GPUs, install CUDA toolkit from:" >&2
                    echo "  https://developer.nvidia.com/cuda-downloads" >&2
                    ;;
                fedora|rhel|centos|rocky|almalinux)
                    echo -e "  ${GREEN}sudo dnf install -y ocl-icd ocl-icd-devel opencl-headers${NC}" >&2
                    ;;
                arch|manjaro)
                    echo -e "  ${GREEN}sudo pacman -S ocl-icd opencl-headers${NC}" >&2
                    ;;
                opensuse*)
                    echo -e "  ${GREEN}sudo zypper install ocl-icd-devel opencl-headers${NC}" >&2
                    ;;
                *)
                    echo "  Install OpenCL ICD loader and headers using your package manager" >&2
                    ;;
            esac
            echo "" >&2
            opencl_ok=false
        fi
    elif [ "$OS" == "macos" ]; then
        # macOS has OpenCL built-in, but deprecated
        # On modern macOS (Sequoia+), the framework structure changed
        if [ ! -d /System/Library/Frameworks/OpenCL.framework ]; then
            print_warning "OpenCL framework not found (unexpected on macOS)"
            opencl_ok=false
        fi
    fi

    return $([ "$opencl_ok" = true ] && echo 0 || echo 1)
}

# Check PTX/CUDA dependencies
check_ptx_backend() {
    if ! command_exists nvidia-smi; then
        print_warning "NVIDIA driver is not installed"
        echo "" >&2
        echo "The PTX backend requires NVIDIA CUDA Toolkit and drivers." >&2
        echo "" >&2
        echo -e "Visit: ${GREEN}https://developer.nvidia.com/cuda-downloads${NC}" >&2
        echo "" >&2

        case $DISTRO in
            ubuntu|debian)
                echo "Or install via package manager:" >&2
                echo -e "  ${GREEN}wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.1-1_all.deb${NC}" >&2
                echo -e "  ${GREEN}sudo dpkg -i cuda-keyring_1.1-1_all.deb${NC}" >&2
                echo -e "  ${GREEN}sudo apt update${NC}" >&2
                echo -e "  ${GREEN}sudo apt install -y cuda${NC}" >&2
                ;;
            *)
                echo "Follow instructions at: https://developer.nvidia.com/cuda-downloads" >&2
                ;;
        esac
        echo "" >&2
        return 1
    fi
    return 0
}

# Check SPIR-V dependencies
check_spirv_backend() {
    local spirv_ok=true

    # SPIR-V backend can use either Level Zero or OpenCL 2.1+
    if [ "$OS" == "linux" ]; then
        # Check if SPIR-V backend library exists in SDK
        local spirv_lib=""
        if [ -f "$TORNADOVM_HOME/lib/libtornado-levelzero.so" ]; then
            spirv_lib="$TORNADOVM_HOME/lib/libtornado-levelzero.so"
        fi

        # If SPIR-V library exists, check if its dependencies are satisfied
        if [ -n "$spirv_lib" ]; then
            # Use ldd to check if all dependencies can be resolved
            if ! ldd "$spirv_lib" 2>/dev/null | grep -q "not found"; then
                # All dependencies satisfied, Level Zero is available (bundled or system-wide)
                spirv_ok=true
            else
                # Dependencies missing
                print_warning "SPIR-V backend dependencies are missing"
                echo "" >&2
                echo "The SPIR-V backend requires Level Zero or OpenCL 2.1+." >&2
                echo "" >&2
                echo "Missing dependencies:" >&2
                ldd "$spirv_lib" 2>/dev/null | grep "not found" >&2
                echo "" >&2
                echo "To install Level Zero for Intel GPUs:" >&2
                echo "" >&2

                case $DISTRO in
                    ubuntu|debian)
                        echo -e "  ${GREEN}sudo apt update${NC}" >&2
                        echo -e "  ${GREEN}sudo apt install -y intel-level-zero-gpu level-zero${NC}" >&2
                        echo "" >&2
                        echo "For Intel Compute Runtime:" >&2
                        echo "  Visit: https://github.com/intel/compute-runtime/releases" >&2
                        ;;
                    fedora|rhel|centos|rocky|almalinux)
                        echo -e "  ${GREEN}sudo dnf install -y level-zero intel-level-zero${NC}" >&2
                        ;;
                    arch|manjaro)
                        echo -e "  ${GREEN}sudo pacman -S level-zero-loader${NC}" >&2
                        ;;
                    *)
                        echo "  Visit: https://github.com/oneapi-src/level-zero" >&2
                        ;;
                esac
                echo "" >&2
                echo "Alternatively, SPIR-V can use OpenCL 2.1+ (see OpenCL dependencies above)" >&2
                echo "" >&2
                spirv_ok=false
            fi
        else
            # SPIR-V library not found in SDK, skip check (backend not installed)
            spirv_ok=true
        fi
    fi

    return $([ "$spirv_ok" = true ] && echo 0 || echo 1)
}

# Check backend-specific dependencies
check_backend_dependencies() {
    get_installed_backends

    if [ -z "$INSTALLED_BACKENDS" ]; then
        return 0
    fi

    local has_warnings=false

    for backend in $INSTALLED_BACKENDS; do
        case $backend in
            *opencl*)
                if ! check_opencl_backend; then
                    has_warnings=true
                fi
                ;;
            *ptx*)
                if ! check_ptx_backend; then
                    has_warnings=true
                fi
                ;;
            *spirv*)
                if ! check_spirv_backend; then
                    has_warnings=true
                fi
                ;;
        esac
    done

    # Return success even if there are warnings (backend deps are not critical)
    # The warnings are informational
    return 0
}

# Main execution
detect_os

# Check critical dependencies
DEPS_OK=true

if ! check_python3; then
    DEPS_OK=false
fi

if ! check_java; then
    DEPS_OK=false
fi

if ! check_tornado_sdk; then
    DEPS_OK=false
fi

# Exit if critical dependencies are missing
if [ "$DEPS_OK" = false ]; then
    exit 1
fi

# Check backend dependencies (warnings only)
check_backend_dependencies

# If all critical checks pass, execute the actual tornado launcher
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TORNADO_LAUNCHER="$SCRIPT_DIR/tornado.py"

if [ ! -f "$TORNADO_LAUNCHER" ]; then
    print_error "TornadoVM launcher not found at: $TORNADO_LAUNCHER"
    exit 1
fi

# Execute the Python launcher with all arguments
exec python3 "$TORNADO_LAUNCHER" "$@"
