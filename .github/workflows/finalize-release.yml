name: Finalize TornadoVM Release

on:
  pull_request:
    types: [closed]
    branches: [master]
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version to tag (e.g., 2.0.1)'
        required: true
        type: string
      next_dev_version:
        description: 'Next development version (e.g., 2.0.2-dev)'
        required: true
        type: string

jobs:
  create-release-tag:
    # Run when release PR merges OR manual trigger
    if: |
      (github.event.pull_request.merged == true && startsWith(github.event.pull_request.head.ref, 'release/')) ||
      github.event_name == 'workflow_dispatch'
    runs-on: [self-hosted, Linux, x64]
    permissions:
      contents: write
    timeout-minutes: 10
    
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    
    steps:
      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            BRANCH="${{ github.event.pull_request.head.ref }}"
            echo "version=${BRANCH#release/}" >> $GITHUB_OUTPUT
          fi

      - name: Checkout master
        uses: actions/checkout@v4
        with:
          ref: master
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create and push tag
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          git tag -a "v${VERSION}" -m "Release ${VERSION}"
          git push origin "v${VERSION}"
          echo "âœ… Created tag v${VERSION}"

      - name: Extract changelog for release notes
        id: changelog
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          CHANGELOG_FILE="docs/source/CHANGELOG.rst"
          
          if [ -f "$CHANGELOG_FILE" ]; then
            # Extract section for this version
            awk -v ver="TornadoVM ${VERSION}" '
              $0 ~ ver { found=1; next }
              found && /^TornadoVM [0-9]+\.[0-9]+\.[0-9]+$/ { exit }
              found { print }
            ' "$CHANGELOG_FILE" > /tmp/release_notes.txt
            
            echo "Found changelog section for ${VERSION}"
          else
            echo "See CHANGELOG.rst for details." > /tmp/release_notes.txt
          fi

      - name: Create GitHub Release
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const version = '${{ steps.get_version.outputs.version }}';
            
            let releaseNotes;
            try {
              releaseNotes = fs.readFileSync('/tmp/release_notes.txt', 'utf8').trim();
              if (!releaseNotes) {
                releaseNotes = `Release ${version}\n\nSee CHANGELOG.rst for details.`;
              }
            } catch (e) {
              releaseNotes = `Release ${version}\n\nSee CHANGELOG.rst for details.`;
            }
            
            const { data: release } = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: `v${version}`,
              name: `TornadoVM ${version}`,
              body: releaseNotes,
              draft: false,
              prerelease: false
            });
            
            console.log(`âœ… Created release: ${release.html_url}`);

  update-develop:
    needs: create-release-tag
    runs-on: [self-hosted, Linux, x64]
    permissions:
      contents: write
    timeout-minutes: 10
    env:
      JAVA_HOME: /opt/jenkins/jdks/graal-23.1.0/jdk-21.0.3
      MAVEN_HOME: /opt/maven
    
    steps:
      - name: Checkout develop
        uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup environment
        run: |
          echo "$JAVA_HOME/bin" >> $GITHUB_PATH
          echo "$MAVEN_HOME/bin" >> $GITHUB_PATH

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Merge master into develop
        run: |
          git fetch origin master
          git merge origin/master -m "Merge master after release ${{ needs.create-release-tag.outputs.version }}"

      - name: Determine next dev version
        id: next_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "next_version=${{ inputs.next_dev_version }}" >> $GITHUB_OUTPUT
          else
            VERSION="${{ needs.create-release-tag.outputs.version }}"
            IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
            echo "next_version=${MAJOR}.${MINOR}.$((PATCH + 1))-dev" >> $GITHUB_OUTPUT
          fi

      - name: Bump to next dev version
        run: |
          NEXT="${{ steps.next_version.outputs.next_version }}"
          
          ./mvnw versions:set -DnewVersion=${NEXT} -DgenerateBackupPoms=false
          
          sed -i "s/__VERSION__ = \"[0-9]\+\.[0-9]\+\.[0-9]\+\"/__VERSION__ = \"${NEXT}\"/" tornado-assembly/src/bin/tornado-test
          
          git add -A
          git commit -m "Bump version to ${NEXT} for development"
          git push origin develop

      - name: Summary
        run: |
          echo "## ðŸŽ‰ Release Finalized" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Tag created | âœ… v${{ needs.create-release-tag.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| GitHub Release | âœ… Created |" >> $GITHUB_STEP_SUMMARY
          echo "| Develop bumped | âœ… ${{ steps.next_version.outputs.next_version }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Remaining manual steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Run **deploy-maven-central** workflow" >> $GITHUB_STEP_SUMMARY
          echo "2. Announce release" >> $GITHUB_STEP_SUMMARY
