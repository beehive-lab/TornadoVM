name: Rerun Checks on Command
on:
  issue_comment:
    types: [created]
permissions:
  contents: read
  actions: write
jobs:
  rerun:
    if: >
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/rerun') &&
      (
        github.event.comment.author_association == 'OWNER' ||
        github.event.comment.author_association == 'MEMBER' ||
        github.event.comment.author_association == 'COLLABORATOR'
      )
    runs-on: self-hosted
    steps:
      - name: Get PR head ref
        id: pr
        run: |
          PR_DATA=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.issue.number }})
          echo "head_ref=$(echo $PR_DATA | jq -r .head.ref)" >> $GITHUB_OUTPUT

      - name: Trigger build workflow
        run: |
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/build.yml/dispatches \
            -d '{"ref": "${{ steps.pr.outputs.head_ref }}"}'